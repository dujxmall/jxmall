<?php
/**
 * @link:http://www.dujxmall.com/
 * @copyright: Copyright (c) 2020 广州动力宇宙信息科技
 * Created by PhpStorm
 * Author: ganxiaohao
 * Date: 2020-12-31
 * Time: 17:50
 */

namespace app\plugins\article\forms\api;


use app\core\ApiCode;
use app\helpers\DateHelper;
use app\helpers\ResponseHelper;
use app\models\BaseModel;
use app\plugins\article\models\Article;

class ArticleListForm extends BaseModel
{

    public $page;
    public $limit = 10;
    public $cat_id;


    public function rules()
    {
        return [
            [['page', 'limit', 'cat_id'], 'integer'],
        ]; // TODO: Change the autogenerated stub
    }


    public function getList()
    {
        if (!$this->validate()) {
            return $this->responseErrorInfo();

        }

        $query = Article::find()->where(['is_delete' => 0, 'mall_id' => \Yii::$app->mall->id, 'is_published' => 1]);
        if ($this->cat_id) {
            $query->andWhere(['cat_id' => $this->cat_id]);
        }
        if ($this->page) {

            $query->page($pagination, $this->limit, $this->page);
        }


        $query->orderBy('sort desc');
        $list = $query->asArray()->all();
        foreach ($list as &$item) {
            $item['created_at'] = $this->createdTime($item['created_at']);
        }
        unset($item);
        return ResponseHelper::send(ApiCode::CODE_SUCCESS, '', ['list' => $list, 'pagination' => $pagination]);
    }


    private function createdTime($time)
    {


        $t = time() - $time;
        $f = array(
            '31536000' => '年',
            '2592000' => '个月',
            '604800' => '星期',
            '86400' => '天',
            '3600' => '小时',
            '60' => '分钟',
            '1' => '秒'
        );
        foreach ($f as $k => $v) {
            if (0 != $c = floor($t / (int)$k)) {
                return $c . $v . '前';
            }
        }
    }


}