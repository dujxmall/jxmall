<?php
/**
 * @link:http://www.dujxmall.com/
 * @copyright: Copyright (c) 2020 广州动力宇宙信息科技
 * Created by PhpStorm
 * Author: ganxiaohao
 * Date: 2021-04-21
 * Time: 15:07
 */

namespace app\forms\api\index;


use app\core\ApiCode;
use app\helpers\SerializeHelper;
use app\models\BaseModel;
use app\models\DiyPage;
use app\models\GoodsInfo;

class DiyPageForm extends BaseModel
{

    public $id;

    public function rules()
    {
        return [
            [['id'], 'integer'],

        ]; // TODO: Change the autogenerated stub
    }

    public function getPageData()
    {
        if (!$this->validate()) {
            return $this->responseErrorInfo();
        }
        $page = DiyPage::findOne(['is_delete' => 0, 'id' => $this->id, 'mall_id' => \Yii::$app->mall->id]);
        if (!$page) {
            return $this->apiResponse(ApiCode::CODE_FAIL, '页面找不到');
        }
        $name = $page->name;
        $data = SerializeHelper::decode($page->data);

        if(\Yii::$app->user->isGuest){
            $level = -1;
        }else{
            $level = \Yii::$app->user->identity->level;
        }
        foreach ($data as &$item) {
            if ($item['name'] == 'goods-group') {//商品组
                $list = $item['data']['list'];
                $newList = [];
                foreach ($list as $goods) {
                    $goodsInfo = GoodsInfo::findOne(['goods_id' => $goods['id']]);
                    if ($goodsInfo) {
                        if (!$goodsInfo->permission) {
                            $newList[] = $goods;
                        } else {
                            $permission = SerializeHelper::decode($goodsInfo->permission);
                            if ($permission) {
                                if ($permission['explode_is_level']) {
                                    if (in_array($level, $permission['explode_levels'])) {
                                        $newList[] = $goods;
                                    }
                                }
                            }
                        }
                    }
                }
                $item['data']['list'] = $newList;
                unset($item);
            }
        }
        return $this->apiResponse(ApiCode::CODE_SUCCESS, '', ['page_data' => $data, 'name' => $name]);
    }

}