<?php
/**
 * Created by PhpStorm.
 * User: ganxi
 * Date: 2022/3/24
 * Time: 17:36
 * Note:
 */

namespace app\forms\api\login;


use app\core\ApiCode;
use app\helpers\ResponseHelper;
use app\helpers\WechatHelper;
use app\models\BaseModel;
use EasyWeChat\Kernel\Exceptions\InvalidConfigException;

class WechatUserInfoForm extends BaseModel
{

    public $code;
    public $encryptedData;
    public $iv;
    public $access_token;
    public $openId;
    public $unionId;
    public $avatarUrl;
    public $nickName;

    public function rules()
    {
        return [
            [['code', 'iv', 'encryptedData', 'openId', 'unionId', 'nickName', 'avatarUrl'], 'string']
        ]; // TODO: Change the autogenerated stub
    }

    public function mpwxUser()
    {
        WechatHelper::init(\Yii::$app->mall->id);
        $app = \Yii::$app->wechat->miniProgram;
        if (!$app) {
            return $this->apiResponse(ApiCode::CODE_FAIL, '小程序配置失败');
        }
        try {
            $session = $app->auth->session($this->code);
        } catch (InvalidConfigException $e) {
            return $this->apiResponse(ApiCode::CODE_FAIL, $e->getMessage());
        }

        if (isset($session['unionid'])) {
            $result['unionId'] = $session['unionid'];//
        }
        $result['openid'] = $session['openid'];
        return ResponseHelper::send(ApiCode::CODE_SUCCESS, '', ['result' => $result]);
    }

}