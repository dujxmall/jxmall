<?php
/**
 * Created by PhpStorm.
 * User: ganxi
 * Date: 2022/3/15
 * Time: 16:26
 * Note:
 */

namespace app\forms\mall\market;


use app\core\ApiCode;
use app\helpers\DateHelper;
use app\helpers\ResponseHelper;
use app\models\BaseModel;
use app\models\Coupon;
use app\models\UserCoupon;

class CouponSendForm extends BaseModel
{
    public $coupon_id;
    public $uids;

    public function rules()
    {
        return [
            [['uids'], 'safe'],
            [['coupon_id'], 'integer']
        ]; // TODO: Change the autogenerated stub
    }


    public function send()
    {

        if (!$this->uids) {
            return ResponseHelper::send(ApiCode::CODE_FAIL, '请选择用户');
        }

        $coupon = Coupon::findOne(['is_delete' => 0, 'id' => $this->coupon_id]);

        if (!$coupon) {
            return ResponseHelper::send(ApiCode::CODE_FAIL, '优惠券不存在！请确认');
        }

        $i = 0;
        foreach ($this->uids as $uid) {
            if ($coupon->is_limit_total) {
                $total = Coupon::getTotal($coupon->id);
                if ($total > 0) {
                    $userCoupon = new UserCoupon();
                    $userCoupon->mall_id = $this->mall_id;
                    $userCoupon->coupon_id = $coupon->id;
                    $userCoupon->price = $coupon->price;
                    $userCoupon->discount = $coupon->discount;
                    $userCoupon->user_id = $uid;
                    $userCoupon->mch_id = 0;
                    $userCoupon->remarks = "后台发券";
                    if ($coupon->time_type == 1) {
                        $userCoupon->start_at = $coupon->start_at;
                        $userCoupon->end_at = $coupon->end_at;
                    } else {
                        $userCoupon->start_at = time();
                        $userCoupon->end_at = $coupon->day * 24 * 60 * 60 + time();
                    }
                    $i++;
                    if(!$userCoupon->save()){
                        return $this->responseErrorMsg($userCoupon);
                    }
                    Coupon::decTotal($coupon->id, 1);
                } else {
                    return ResponseHelper::send(ApiCode::CODE_FAIL, '优惠券数量不足了，已发放人数:' . $i);
                }
            }else{
                $userCoupon = new UserCoupon();
                $userCoupon->mall_id = $this->mall_id;
                $userCoupon->coupon_id = $coupon->id;
                $userCoupon->price = $coupon->price;
                $userCoupon->discount = $coupon->discount;
                $userCoupon->user_id = $uid;
                $userCoupon->mch_id = 0;
                $userCoupon->remarks = "后台发券";
                if ($coupon->time_type == 1) {
                    $userCoupon->start_at = $coupon->start_at;
                    $userCoupon->end_at = $coupon->end_at;
                } else {
                    $userCoupon->start_at = time();
                    $userCoupon->end_at = $coupon->day * 24 * 60 * 60 + time();
                }
                $i++;
                if(!$userCoupon->save()){
                    return $this->responseErrorMsg($userCoupon);
                }
            }
        }
        return ResponseHelper::send(ApiCode::CODE_SUCCESS, '发放完成，人数：' . $i);
    }

}