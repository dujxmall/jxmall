<?php
/**
 * @link:http://www.dujxmall.com/
 * @copyright: Copyright (c) 2020 广州动力宇宙信息科技
 * Created by PhpStorm
 * Author: ganxiaohao
 * Date: 2020-11-07
 * Time: 17:40
 */

namespace app\forms\mall\order;


use app\core\ApiCode;
use app\helpers\EOrderServiceHelper;
use app\helpers\SerializeHelper;
use app\models\BaseModel;
use app\models\Eorder;
use app\models\EorderDetail;
use app\models\ExpressLog;

class ExpressLogEorderForm extends BaseModel
{
    public $log_id;
    public $eorder_id;


    public function rules()
    {
        return [
            [['log_id', 'eorder_id'], 'string'],

        ]; // TODO: Change the autogenerated stub
    }

    public function search()
    {
        $log = ExpressLog::findOne(['is_delete' => 0, 'id' => $this->log_id]);
        if (!$log) {
            return $this->apiResponse(ApiCode::CODE_FAIL, '发货记录不存在');
        }
        if (!$log->eorder_detail_id || !$log->eorder_id) {
            $log->eorder_detail_id = 0;
            $log->eorder_id = 0;
            $log->save();
            return $this->apiResponse(ApiCode::CODE_FAIL, '请选择电子面单模板');
        }
        $eorderModel = EorderDetail::findOne(['id' => $log->eorder_detail_id, 'is_delete' => 0]);
        if (!$eorderModel) {
            $log->eorder_detail_id = 0;
            $log->eorder_id = 0;
            $log->save();
            return $this->apiResponse(ApiCode::CODE_FAIL, '请选择电子面单模板');
        }

        return $this->apiResponse(ApiCode::CODE_SUCCESS, '', ['print_tpl' => SerializeHelper::decode($eorderModel->print_tpl)]);
    }

    public function setEorder()
    {

        if (!$this->validate()) {
            return $this->responseErrorInfo();
        }

        $eorderModel = Eorder::findOne(['id' => $this->eorder_id, 'is_delete' => 0]);
        if (!$eorderModel) {
            return $this->apiResponse(ApiCode::CODE_FAIL, '电子面单模板不存在');
        }

        $log = ExpressLog::findOne(['is_delete' => 0, 'id' => $this->log_id]);
        if (!$log) {
            return $this->apiResponse(ApiCode::CODE_FAIL, '发货记录不存在');
        }

        $eorderDetail = EorderDetail::findOne(['express_no' => $log->express_no, 'is_delete' => 0, 'mall_id' => \Yii::$app->mall->id, 'eorder_id' => $this->eorder_id]);
        if ($eorderDetail) {
            $log->eorder_detail_id = $eorderDetail->id;
            $log->eorder_id = $this->eorder_id;
            if (!$log->save()) {
                return $this->responseErrorMsg($log);
            }
            return $this->apiResponse(ApiCode::CODE_SUCCESS, '设置成功');
        }

        $eorder["ShipperCode"] = $eorderModel->express_key;
        $eorder["OrderCode"] = $log->express_no;

        //1-现付，2-到付，3-月结
        $eorder["PayType"] = $eorderModel->pay_type + 1;
        $eorder["ExpType"] = 1;
        $eorder['IsReturnPrintTemplate'] = 1;
        //传入商户信息

        if ($eorderModel->account) {
            $eorder['CustomerName'] = $eorderModel->account;
            $eorder['CustomerPwd'] = $eorderModel->password;
            $eorder['SendSite'] = $eorderModel->shop_code;
            $eorder['MonthCode'] = $eorderModel->month_code;
        }


        $sender = [];
        $sender["Name"] = $eorderModel->sender_name;
        $sender["Mobile"] = $eorderModel->sender_mobile;
        $sender["ProvinceName"] = $eorderModel->sender_province;
        $sender["CityName"] = $eorderModel->sender_city;
        $sender["ExpAreaName"] = $eorderModel->sender_county;
        $sender["Address"] = $eorderModel->sender_address;
        $receiver = [];

        $address = explode(' ', $log->address);
        $receiver["Name"] = $log->name;
        $receiver["Mobile"] = $log->mobile;
        $receiver["ProvinceName"] = $address[0];
        $receiver["CityName"] = $address[1];
        $receiver["ExpAreaName"] = $address[2];
        if (count($address) == 5) {
            $receiver["Address"] = $address[3].' '.$address[4];
        } else {
            $receiver["Address"] = $address[3];
        }
        $commodityOne = [];
        $commodityOne["GoodsName"] = "其他";
        $commodityOne['Goodsquantity'] = $log->num;
        $commodity[] = $commodityOne;
        $eorder["Sender"] = $sender;
        $eorder["Receiver"] = $receiver;
        $eorder["Commodity"] = $commodity;
        $result = EOrderServiceHelper::submitEOrder(SerializeHelper::encode($eorder), \Yii::$app->mall->id);
        $result = SerializeHelper::decode($result);
        if (isset($result["ResultCode"]) && $result["ResultCode"] == "100" || $result["ResultCode"] == '106') {
            //获取成功
            $eorderDetail = new EorderDetail();
            $eorderDetail->mall_id = \Yii::$app->mall->id;
            $eorderDetail->eorder_id = $this->eorder_id;
            $eorderDetail->express_no = $log->express_no;
            $eorderDetail->print_tpl = SerializeHelper::encode($result['PrintTemplate']);
            if (!$eorderDetail->save()) {
                return $this->responseErrorMsg($eorderDetail);
            }
            $log->eorder_detail_id = $eorderDetail->id;
            $log->eorder_id = $this->eorder_id;
            if (!$log->save()) {
                return $this->responseErrorMsg($log);
            }
            return $this->apiResponse(ApiCode::CODE_SUCCESS, '设置成功');

        } else {
            return [
                'code' => ApiCode::CODE_FAIL,
                'msg' => $result['Reason'],
                'data' => $result
            ];
        }
        return $this->apiResponse(ApiCode::CODE_SUCCESS, '');
    }
}