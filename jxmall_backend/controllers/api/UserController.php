<?php
/**
 * @link:http://www.dujxmall.com/
 * @copyright: Copyright (c) 2020 广州动力宇宙信息科技
 * Created by PhpStorm
 * Author: ganxiaohao
 * Date: 2020-09-17
 * Time: 15:56
 */

namespace app\controllers\api;


use app\controllers\api\filters\LoginFilter;

use app\core\ApiCode;
use app\forms\api\user\CheckBindingForm;
use app\forms\api\user\GoodsFootmarkListForm;
use app\forms\api\user\IndexDataForm;
use app\forms\api\user\TeamListForm;
use app\forms\api\user\UserAddressForm;
use app\forms\api\user\UserEncryptedForm;
use app\forms\api\user\UserForm;
use app\models\Feedback;
use app\models\User;

class UserController extends Controller
{
    public function behaviors()
    {
        return array_merge(parent::behaviors(),
            [
                'login' => [
                    'class' => LoginFilter::class,
                    'ignore' => ['page-data', 'check-binding']
                ],
            ]
        ); // TODO: Change the autogenerated stub
    }

    /**
     * Created by: ganxh
     * Date: 2021/11/9
     * Time: 14:28
     * Note:检查是否需要绑定
     * @return \yii\web\Response
     */
    public function actionCheckBinding()
    {
        $form = new CheckBindingForm();
        return $this->asJson($form->search());
    }

    /**
     * Created by: ganxh
     * Date: 2021/11/9
     * Time: 14:28
     * Note:解析
     * @return \yii\web\Response
     */
    public function actionEncrypted()
    {
        $form = new UserEncryptedForm();
        $form->attributes = $this->request->post();
        return $this->asJson($form->encrypted());
    }

    /**
     * Created by: ganxh
     * Date: 2021/11/9
     * Time: 14:29
     * Note:绑定手机号
     * @return \yii\web\Response
     */
    public function actionBinding()
    {
        $form = new UserForm();
        $form->attributes = $this->request->post();
        return $this->asJson($form->bind());
    }

    /**
     * @Author: 动力宇宙 ganxiaohao
     * @Date: 2020-09-17
     * @Time: 16:06
     * @Note:用户信息
     */
    public function actionIndex()
    {
        $form = new IndexDataForm();
        return $this->asJson($form->getData());
    }

    public function actionPageData()
    {
        $form = new IndexDataForm();
        return $this->asJson($form->getPageData());
    }


    /**
     * @Author: 动力宇宙 ganxiaohao
     * @Date: 2020-10-11
     * @Time: 22:25
     * @Note:地址删除
     * @return \yii\web\Response
     */
    public function actionAddressDelete()
    {
        $form = new UserAddressForm();
        $form->attributes = $this->request->post();
        return $this->asJson($form->delete());
    }


    /**
     * @Author: 动力宇宙 ganxiaohao
     * @Date: 2020-09-17
     * @Time: 16:06
     * @Note:地址编辑
     */
    public function actionAddressEdit()
    {
        $form = new UserAddressForm();
        if ($this->request->isPost) {
            $form->attributes = $this->request->post();
            return $this->asJson($form->save());
        }
        $form->attributes = $this->request->get();
        return $this->asJson($form->search());
    }

    /**
     * @Author: 动力宇宙 ganxiaohao
     * @Date: 2020-09-17
     * @Time: 16:26
     * @Note:地址列表
     * @return \yii\web\Response
     */
    public function actionAddressList()
    {
        $form = new UserAddressForm();
        $form->attributes = $this->request->get();
        return $this->asJson($form->getList());
    }

    public function actionLogout()
    {
        /**
         *
         * @var User $user
         */
        $user = \Yii::$app->user->identity;
        if (!$user) {
            return $this->asJson(['code' => ApiCode::CODE_FAIL, 'msg' => '用户未认证']);
        }
        $user->access_token = null;
        $user->auth_key = null;
        if (!$user->save()) {
            return $this->asJson(['code' => ApiCode::CODE_FAIL, 'msg' => '退出失败', ['error' => $user->getErrors()]]);
        }
        return $this->asJson(['code' => ApiCode::CODE_SUCCESS, 'msg' => '退出成功']);
    }

    public function actionTeam()
    {
        $form = new TeamListForm();
        $form->attributes = $this->request->get();
        return $this->asJson($form->getList());
    }

    public function actionGoodsFootmark()
    {
        $form = new GoodsFootmarkListForm();
        $form->attributes = $this->request->get();
        return $this->asJson($form->getList());
    }
    /**
     * Created by PhpStorm.
     * User：ganxi
     * Date：2022/3/14
     * Time：8:37
     * Note：意见反馈
     */
    public function actionFeedback()
    {
        $form = new Feedback();
        $form->attributes = $this->request->post();
        return $this->asJson($form->save());
    }
    /**
     * Created by PhpStorm.
     * User：ganxi
     * Date：2022/3/12
     * Time：10:42
     * Note：设置生日
     */
    public function actionSetBirthday()
    {
        $form = new UserForm();
        $form->attributes = $this->request->post();
        return $this->asJson($form->setBirthday());
    }

}
